<!-- Generated by agents-reverse-engineer -->

# companion

The Vibe Companion — a web UI that reverse-engineers the Claude Code CLI `--sdk-url` WebSocket protocol to provide browser-based control over multiple sessions with streaming, tool call visibility, permission management, and Codex backend support.

## Stack

**Runtime:** Bun 1.0+  
**Backend:** Hono 4.7 (port 3456, dual WebSocket+REST)  
**Frontend:** React 19 + Vite 6.3 (dev HMR on 5174, production from `dist/`)  
**State:** Zustand 5.0 client store, JSON file persistence (`$TMPDIR/vibe-sessions/`)  
**CLI:** Published as `the-vibe-companion` via `bunx`  
**Testing:** Vitest 4.0 with jsdom for React, Node.js for server  
**Isolation:** Git worktree per session (stored in `~/.companion/worktrees/`)

## Architecture

### Three-Layer Protocol Bridge

```
Browser React (:5174) ←WebSocket /ws/browser/:id→ Hono (:3456) ←WebSocket NDJSON /ws/cli/:id→ Claude CLI (--sdk-url)
                                                      ↓
                                          Codex app-server (stdio JSON-RPC 2.0)
```

Server discriminates by URL path: `/ws/cli/:id` upgrades to CLI backend socket (NDJSON), `/ws/browser/:id` upgrades to typed JSON frontend socket. `WsBridge` maintains per-session `Session` with `messageHistory`, `pendingPermissions`, `state`, `codexAdapter`. Backend selection (`claude-code` vs `codex`) determined at session creation, drives `CliLauncher.launch()` branch (spawns `claude --sdk-url` or `codex app-server` with `CodexAdapter` stdio translator). All downstream routing backend-agnostic.

### Message Flow

User submits prompt → browser POST `/api/sessions/create` → server spawns CLI subprocess with `--sdk-url ws://localhost:3456/ws/cli/SESSION_ID` → CLI connects back → server bridges `SDKSystemMessage` (init), `SDKAssistantMessage`, `SDKPartialAssistantMessage` (stream_event), `SDKControlRequest` (can_use_tool) to browser as typed JSON → browser renders tool calls in `MessageBubble`, approval UI in `PermissionBanner` → user approves → server relays `SDKControlResponse` to CLI → CLI continues execution → server receives `SDKResultSuccess`/`SDKResultError` → broadcasts completion to browsers.

Codex flow: `item/started` → `stream_event`, `item/agentMessage/delta` → `assistant` with streaming content, `item/commandExecution/requestApproval` → `permission_request` (auto-approved for MCP/WebSearch per `CODEX_MAPPING.md`), `turn/completed` → `CLIResultMessage`.

## Contents

### Project Root

- [CLAUDE.local.md](./CLAUDE.local.md) — Project-specific guidance to Claude Code AI assistant documenting architecture (five-hop data flow with ports 3456/5174, WebSocket endpoints `/ws/cli/:id` and `/ws/browser/:id`), development commands (`bun run dev`, `make dev`, typecheck, build+start), testing policy (Vitest with colocated tests, husky pre-commit hook, forbidden test removal without approval), codebase map (backend: `index.ts`, `ws-bridge.ts`, `cli-launcher.ts`, `session-store.ts`, `session-types.ts`, `routes.ts`, `env-manager.ts`; frontend: `store.ts`, `ws.ts`, `types.ts`, `api.ts`, `App.tsx`, `components/`; CLI: `bin/cli.ts`), protocol specification (NDJSON message types `system`, `assistant`, `result`, `stream_event`, `control_request`), session persistence (`$TMPDIR/vibe-sessions/` with PID detection and `--resume`), browser testing constraint (`agent-browser` only), pull request requirements (Commitizen, screenshots, explanation, human review disclosure).

- [Makefile](./Makefile) — Defines `make dev` (delegates to `cd web && bun run dev`), declares `.PHONY` targets `build`, `start`.

- [package.json](./package.json) — Root monorepo config with `name: "the-vibe-companion"`, `version: "0.18.0"`, `private: true`, scripts delegating to `web/` subdirectory (`dev`, `build`, `start`), `prepare` script running `husky` for git hooks, devDependencies `husky@9.1.7`, production dependency `the-vibe-companion@^0.2.2` (self-reference for dual library/application publishing).

- [README.md](./README.md) — User-facing quickstart documenting `bunx the-vibe-companion` command, architecture ASCII diagram with WebSocket endpoints (`/ws/cli/:session`, `/ws/browser/:session`), six core features (multi-session, streaming, tool visibility, subagent nesting, permission modes, `--resume` recovery), environment profiles in `~/.companion/envs/`, tech stack (Bun, Hono, React 19, Zustand, Tailwind v4), dev commands (`bun run dev` for backend+Vite HMR on 5174, `bun run build && bun run start` for production), MIT license, GitHub repo link `The-Vibe-Company/companion`.

- [WEBSOCKET_PROTOCOL_REVERSED.md](./WEBSOCKET_PROTOCOL_REVERSED.md) — Comprehensive reverse-engineering spec for Claude Code CLI v2.1.37 `--sdk-url` protocol. Documents NDJSON-over-WebSocket transport, launch flags (`--sdk-url`, `--print`, `--output-format stream-json`), six transport classes (`ProcessInputTransport`, `SdkUrlTransport`, `WebSocketTransport`, `HybridTransport`, `SessionsWS`, `RemoteSessionMgr`, `DirectConnectWebSocket`), connection lifecycle (init → `control_request/initialize` → `user` messages → multi-turn), 15+ message types (`SDKSystemMessage`, `SDKAssistantMessage`, `SDKPartialAssistantMessage`, `SDKResultSuccess`, `SDKControlRequest`, `SDKToolProgressMessage`, `SDKHookStartedMessage`, `SDKFilesPersistedEvent`), 13 control subtypes (`initialize`, `can_use_tool`, `interrupt`, `set_permission_mode`, `set_model`, `mcp_status`, `mcp_message`, `mcp_reconnect`, `mcp_toggle`, `mcp_set_servers`, `rewind_files`, `hook_callback`), three-layer permission pipeline (PreToolUse hooks → local rule eval → remote `can_use_tool`), six PermissionMode values (`default`, `acceptEdits`, `bypassPermissions`, `plan`, `delegate`, `dontAsk`), reconnection resilience (max 3 WS attempts with exponential backoff base 1s/max 30s, ping interval 10s, circular buffer capacity 1000, HybridTransport max 10 POST retries), environment variables (`CLAUDE_CODE_SESSION_ACCESS_TOKEN`, `CLAUDE_CODE_POST_FOR_SESSION_INGRESS_V2`), ContentBlock types (text, tool_use, tool_result, thinking), HookEvent types (PreToolUse, PostToolUse, PermissionRequest, SessionStart, TeammateIdle, TaskCompleted).

## Subdirectories

- [scripts/](./scripts/) — Shell utilities for dev environment lifecycle: `dev-start.sh` orchestrates backend (port 3456) and Vite (port 5174) with PID tracking (`.dev-backend.pid`, `.dev-vite.pid`), HTTP health polling (`curl --max-time 3`, 60s max wait, 1s interval), accepts `--start`/`--stop`/`--status` commands, invoked by `make dev`.

- [web/](./web/) — Full-stack application root with Bun+Hono backend (`server/` subdirectory: `index.ts` bootstrap with port 3456, dual WebSocket upgrade, 10s reconnection grace period, auto-naming callback; `ws-bridge.ts` message router with `Session` maintaining `messageHistory`/`pendingPermissions`/`state`/`cliSocket`/`codexAdapter`/`browserSockets`, `resolveGitInfo()` for git metadata; `cli-launcher.ts` subprocess manager spawning Claude Code with `--sdk-url` or Codex `app-server`, relaunching with `--resume`, injecting worktree guardrails; `codex-adapter.ts` JSON-RPC translator with `JsonRpcTransport` writer lock, `item/started` routing, `pendingApprovals`/`pendingUserInputQuestionIds`, rate limits caching; `session-store.ts` file persistence with 150ms debounce for streams, `PersistedSession` JSON; `routes.ts` REST API with session CRUD, filesystem ops, git operations with `isWorktreeInUse()` safety checks, environment profiles, backend discovery, usage limits; `git-utils.ts`/`worktree-tracker.ts` worktree isolation at `~/.companion/worktrees/{repoName}/{sanitizedBranch}` with `-wt-{random4digit}` suffixes, persistent mappings, `ensureWorktree()`; `env-manager.ts` CRUD for profiles at `~/.companion/envs/{slug}.json` with `slugify()` normalization; `usage-limits.ts` OAuth token refresh, macOS Keychain/Windows JSON credentials, 60s cache; `auto-namer.ts` spawning one-shot `claude`/`codex exec` processes with 15s timeout, 500-char prompt, quote stripping; `session-types.ts` protocol interfaces; `session-names.ts` lazy-loaded mapping at `~/.companion/session-names.json`), React 19 frontend (`src/` subdirectory: `App.tsx` root layout with hash routing via `useHash` + `useSyncExternalStore`, three-column grid with Sidebar/ChatView/HomePage/EditorPanel/TaskPanel, responsive overlays, auto-connects restored sessions, syncs dark mode; `store.ts` Zustand with 50+ actions including `appendMessage`, `setStreaming`, `setStreamingStats`, `addTask`, `updateTask`, `addPermission`, `removePermission`, `setSessionName`, `markRecentlyRenamed`, `clearRecentlyRenamed`, `removeSession`, `toggleProjectCollapse`, `setPreviousPermissionMode`, localStorage persistence for `cc-session-names`/`cc-current-session`/`cc-dark-mode`/`cc-notification-sound`/`cc-collapsed-projects`; `ws.ts` WebSocket client with NDJSON parsing, `extractTasksFromBlocks` handling TodoWrite/TaskCreate/TaskUpdate, `extractChangedFilesFromBlocks`, `processedToolUseIds` deduplication, `taskCounters` auto-numbering, 2000ms reconnect delay, `playNotificationSound()` on result; `api.ts` REST client with `CreateSessionOpts` including `backend`/`model`/`permissionMode`/`cwd`/`envSlug`/`branch`/`useWorktree`; `types.ts` re-exports server types plus client-only `ChatMessage`/`TaskItem`/`SdkSessionInfo`; `components/` with ChatView, MessageFeed, MessageBubble, Composer, Sidebar, ProjectGroup, SessionItem, TopBar, TaskPanel, PermissionBanner, ToolBlock, HomePage, EditorPanel, Playground, FolderPicker, EnvManager with message grouping, slash command autocomplete, Git worktree confirmation, permission displays, usage limits countdown, 800ms auto-save debounce, CodeMirror with `warmTheme`; `utils/` with backends.ts providing `getModelsForBackend`/`getModesForBackend`/`getDefaultModel`/`getDefaultMode`/`toModelOptions`/`pickIcon`, names.ts with `generateSessionName` from 40 adjectives × 40 nouns, project-grouping.ts with `extractProjectKey` worktree normalization, notification-sound.ts with Web Audio E5→G5 synthesis, recent-dirs.ts with LRU cache of 5 entries), CLI entry point (`bin/cli.ts` setting `__VIBE_PACKAGE_ROOT`), config files (`package.json` bin entry, `vite.config.ts` proxy to 3456, `vitest.config.ts` environmentMatchGlobs), protocol mapping spec (`CODEX_MAPPING.md` for Codex JSON-RPC 2.0 translation), dev orchestrator (`dev.ts` parallel subprocess spawner with prefix multiplexing).

## Data Flow

1. User runs `bunx the-vibe-companion` → `web/bin/cli.ts` imports `web/server/index.ts`
2. Server starts Hono on 3456, serves `web/dist/` in production or proxies Vite in dev
3. Browser loads React app, renders `HomePage` with session list from `GET /api/sessions`
4. User creates session with backend selection → `POST /api/sessions/create` → `CliLauncher.launch()` spawns subprocess
5. CLI connects to `/ws/cli/:id` → `WsBridge.handleCLIConnect()` upgrades socket, stores in `Session.cliSocket`
6. Browser connects to `/ws/browser/:id` → `WsBridge.handleBrowserConnect()` stores in `browserSockets` Set
7. User sends prompt → `ws.ts` sends `{type: "user", message}` → `WsBridge` relays to CLI socket (Claude) or `codexAdapter.sendMessage()` (Codex)
8. CLI streams responses → `WsBridge.handleCLIMessage()` parses NDJSON → broadcasts to all `browserSockets`
9. Tool calls trigger `control_request` → stored in `pendingPermissions` Map → browser renders `PermissionBanner` → user approves → `control_response` relayed
10. Turn completes → `result` message → `auto-namer.ts` generates title (first turn only) → `SessionNames.setName()` persists → browser receives update
11. `SessionStore` debounces writes (150ms for stream events) to `$TMPDIR/vibe-sessions/{id}.json`

## Session Persistence

`SessionStore.save()` debounces writes to JSON files (150ms default, immediate via `saveSync()` for critical state). Persisted fields: `id`, `state` (model, cwd, tools, permissionMode, git_branch, cost, context), `messageHistory` (full `BrowserIncomingMessage[]`), `pendingMessages` (queued while CLI disconnected), `pendingPermissions` (Map serialized to array). On server restart, `WsBridge.restoreFromDisk()` rehydrates `sessions` Map, `CliLauncher.restoreFromDisk()` detects stale PIDs via `kill -0` check, waits 10s grace period for reconnect, relaunches with `--resume <cliSessionId>` for Claude backend or fresh `CodexAdapter` for Codex backend.

## Git Worktree Isolation

`git-utils.ts` `ensureWorktree(repoRoot, branch)` creates unique paths at `~/.companion/worktrees/{repoName}/{sanitizedBranch}`, generates `-wt-{random4digit}` suffixes for concurrent sessions on same branch via `generateUniqueWorktreeBranch()`. `WorktreeTracker` persists session-to-worktree mappings at `~/.companion/worktrees.json` with `WorktreeMapping` interface (sessionId, repoRoot, branch, actualBranch, worktreePath, createdAt). `CliLauncher.launch()` injects markdown guardrails into `.claude/CLAUDE.md` via `injectWorktreeGuardrails()` when `worktreePath !== repoRoot` and directory exists, with markers `<!-- WORKTREE_GUARDRAILS_START -->`/`<!-- WORKTREE_GUARDRAILS_END -->`, forbidding `git checkout/switch`, enforcing commits to current branch. Routes expose `POST /api/git/worktree`, `DELETE /api/git/worktree` with safety checks via `isWorktreeInUse()` preventing deletion of shared worktrees. Cleanup deletes companion-managed branches via `branchToDelete` parameter.

## Environment Profiles

`EnvManager` stores named variable sets at `~/.companion/envs/{slug}.json` with interface `CompanionEnv` (name, slug, variables: Record<string,string>, createdAt, updatedAt). Slug generation via `slugify()`: lowercase, `.replace(/\s+/g, "-")`, `.replace(/[^a-z0-9-]/g, "")`, `.replace(/-+/g, "-")`, `.replace(/^-|-$/g, "")`. REST API: `GET /envs`, `POST /envs`, `PUT /envs/:slug` (handles slug changes by deleting old file, preserves `createdAt`), `DELETE /envs/:slug`. `HomePage` renders `EnvManager` modal with key-value editor consuming `api.listEnvs()`, `api.createEnv()`. Session creation resolves `envSlug` via `envManager.getEnv()`, merges variables into `env`.

## Task Extraction

`ws.ts` parses all `assistant` and `permission_request` messages for `tool_use` blocks named `TodoWrite`, `TaskCreate`, `TaskUpdate` via `extractTasksFromBlocks()`. Logic: `TodoWrite` expects `input.todos: Array<{content, status, activeForm}>`, calls `setTasks` with renumbered IDs starting from 1; `TaskCreate` increments `taskCounters[sessionId]`, builds `TaskItem` with `id=String(count)`, `subject=input.subject`, `description=input.description`, `activeForm=input.activeForm`, `status="pending"`, calls `addTask`; `TaskUpdate` extracts `taskId` from `input`, builds partial update with `status`, `owner`, `activeForm`, `blockedBy` (from `addBlockedBy`), calls `updateTask`. Deduplicates via `processedToolUseIds.get(sessionId)` Set. `TaskPanel` subscribes to `sessionTasks.get(sessionId)`, renders `TaskRow` with status icons (spinner for `in_progress`, checkmark for `completed`, circle for `pending`), filters by owner/status, displays `blockedBy` dependencies.

## Auto-Naming Pipeline

On session creation, `WsBridge` registers callback invoking `auto-namer.ts` after first completed turn. `generateSessionTitle()` extracts first 500 chars of user message, spawns one-shot CLI process: `claude -p PROMPT --model MODEL --output-format json` for Claude backend (via `generateTitleViaClaude()`, parses `parsed.result` from JSON), `codex exec -q PROMPT --model MODEL --json` for Codex backend (via `generateTitleViaCodex()`, parses JSONL in reverse for last `item.type === "agentMessage"` with `item.completed`, extracts `item.text`). Binary resolution via `resolveClaudeBinary()`, `resolveCodexBinary()` with module-level memoization. Prompt template: `"Generate a concise 3-5 word session title for this user request. Output ONLY the title, nothing else.\n\nRequest: ${first500chars}"`. Strips quotes via `/^["']|["']$/g`, validates length < 100, persists via `SessionNames.setName()`, broadcasts update to browsers via `wsBridge.broadcastNameUpdate()`. 15s timeout, logged warnings on failure.

## Behavioral Contracts

### NDJSON Protocol

CLI processes write newline-delimited JSON to WebSocket. `WsBridge.handleCLIMessage()` splits `data` on `\n`, filters empty lines, parses each line via `JSON.parse()`. Codex adapter uses identical newline-delimited JSON-RPC over stdin/stdout via `JsonRpcTransport.send()` (appends `\n`), `.onData()` (splits on `\n`), `processBuffer()` (parses complete lines). Browser WebSockets receive typed JSON messages without delimiters.

### Git Command Patterns

All git operations in `git-utils.ts` use `execSync` with `timeout: 10_000` ms except routes (3000–5000ms range):
- `git rev-parse --abbrev-ref HEAD` → current branch
- `git rev-parse --show-toplevel` → repo root (non-worktree)
- `git rev-parse --git-dir` → worktree detection (checks `/worktrees/` substring)
- `git rev-parse --git-common-dir` → shared `.git` dir (worktree only, used by `resolveGitInfo`)
- `git rev-list --left-right --count origin/{branch}...{branch}` → `{behind} {ahead}` (parsed via split on whitespace)
- `git for-each-ref refs/heads/ --format '%(refname:short)|%(worktreepath)'` — local branches
- `git for-each-ref refs/remotes/origin/ --format '%(refname:short)|%(worktreepath)'` — remote branches
- `git worktree list --porcelain` → parses lines prefixed `worktree `, `HEAD `, `branch `, `bare`
- `git worktree add -b {branch} "{path}" {base}` → create worktree
- `git worktree remove "{worktreePath}"` (optionally with `--force`)
- `git worktree prune` → cleanup stale metadata
- `git branch -D {branchToDelete}` → delete branch
- `git status --porcelain` → dirty check (`isWorktreeDirty()`)
- `git fetch --prune`, `git pull`
- `git diff HEAD -- "${absPath}"` → file diff

Worktree paths sanitized via `sanitizeBranch()`: replace `/` with `--`, collapse multiple hyphens.

### Auto-Naming Prompt Template

```
Generate a concise 3-5 word session title for this user request. Output ONLY the title, nothing else.

Request: ${first500chars}
```

Claude backend: `claude -p PROMPT --model MODEL --output-format json`, extracts `parsed.result`.  
Codex backend: `codex exec -q PROMPT --model MODEL --json`, parses JSONL for last `item.type === "agentMessage"` with `item.completed`, extracts `item.text`.

Both strip quotes via `/^["']|["']$/g`, validate length < 100 characters, 15s timeout.

### Permission Request Flow

Claude Code: CLI sends `control_request` (subtype `can_use_tool`) → WsBridge stores in `pendingPermissions` Map → broadcasts `permission_request` to browsers → user responds → WsBridge sends `control_response` (behavior `"allow"` or `"deny"`).

Codex: adapter receives `item/commandExecution/requestApproval` or `item/fileChange/requestApproval` JSON-RPC request → stores request ID in `pendingApprovals` → synthesizes `permission_request` → user responds → sends JSON-RPC response `{decision: "accept" | "decline"}`. `item/tool/requestUserInput` → `AskUserQuestion` format with `pendingUserInputQuestionIds` mapping request_id to ordered Codex question IDs → browser response → `ToolRequestUserInputResponse: { answers: { [questionId]: { answers: [string] } } }`.

### WebSocket Reconnection

Browser: `ws.ts` registers `onclose` handler calling `scheduleReconnect(sessionId)` after 2000ms. Checks if session archived in `sdkSessions` before reconnecting. Clears timeout on `onopen`.

CLI: On disconnect, WsBridge stores pending messages in `pendingMessages[]`, waits 10s grace period. If CLI reconnects (server restart case), replays queue. If timeout expires, `CliLauncher.relaunchSession()` kills stale PID, spawns with `--resume <cliSessionId>`.

### LocalStorage Persistence

`store.ts` subscribes to Zustand state changes, writes to localStorage:
- `cc-session-names` → JSON array of `[sessionId, name]` tuples
- `cc-current-session` → active session ID string
- `cc-dark-mode` → `"true"` or `"false"`
- `cc-notification-sound` → `"true"` or `"false"`
- `cc-collapsed-projects` → JSON array of collapsed project key strings

`utils/recent-dirs.ts` persists LRU cache to `cc-recent-dirs` (max 5 entries).

### Context Usage Calculation

Extracted from `result` messages: `Math.round(((inputTokens + outputTokens) / contextWindow) * 100)` clamped to `[0, 100]`. Reads `msg.modelUsage[model].inputTokens`, `msg.modelUsage[model].outputTokens`, `msg.modelUsage[model].modelContextWindow`.

### Worktree Guardrails Injection

Markers: `<!-- WORKTREE_GUARDRAILS_START -->` and `<!-- WORKTREE_GUARDRAILS_END -->`. Only injects when `worktreePath !== repoRoot` and `existsSync(worktreePath)`. Content includes branch label (with `parentBranch` if provided), main repo path, rules forbidding `git checkout/switch`, enforcing commits to current branch only, suggesting `git show other-branch:path`. Written to `.claude/CLAUDE.md` in worktree, replacing existing section or appending.

## Development Commands

```bash
# Dev server (Hono backend on :3456 + Vite HMR on :5174)
cd web && bun install && bun run dev
# Or from repo root
make dev

# Type checking
cd web && bun run typecheck

# Production build + serve
cd web && bun run build && bun run start

# Tests (with watch mode)
cd web && bun run test
cd web && bun run test:watch
```

**Testing Requirements:** All new backend (`web/server/`) and frontend (`web/src/`) code must include tests when possible. Vitest tests live alongside source files. Husky pre-commit hook runs typecheck and tests automatically. Existing tests must never be removed without explicit user approval.

## File Relationships

`Makefile` delegates to `web/package.json` scripts. `web/dev.ts` spawns `web/server/index.ts` and Vite in parallel, orchestrates shutdown. `web/bin/cli.ts` imports `web/server/index.ts` for production execution. `web/server/index.ts` wires together `WsBridge`, `CliLauncher`, `SessionStore`, `WorktreeTracker`, registers routes from `routes.ts`, serves `web/dist/` when `NODE_ENV=production`. `web/server/ws-bridge.ts` delegates subprocess lifecycle to `cli-launcher.ts`, message translation to `codex-adapter.ts`, persistence to `session-store.ts`, git metadata to `git-utils.ts` (`resolveGitInfo`). `web/src/App.tsx` imports `ws.ts` for WebSocket management, `api.ts` for REST calls, `store.ts` for state subscriptions. All components in `web/src/components/` consume `store.ts` via `useStore` selectors, call `api.ts` functions, send messages via `sendToSession` from `ws.ts`. `web/src/types.ts` re-exports `web/server/session-types.ts` for shared protocol definitions across client and server. `web/src/utils/backends.ts` consumed by `TopBar`/`HomePage` for model/mode dropdowns, `utils/names.ts` by `Sidebar`/`HomePage` for session naming, `utils/project-grouping.ts` by `Sidebar` for session organization, `utils/notification-sound.ts` by `ws.ts` for audio notifications, `utils/recent-dirs.ts` by `FolderPicker` for directory history.