<!-- Generated by agents-reverse-engineer -->

# web/src/components

UI component library for the Vibe Companion React application, providing chat, session management, permissions, file editing, and configuration interfaces.

## Contents

### Core Session Components

- [ChatView.tsx](./ChatView.tsx) — Renders session interface with `MessageFeed`, `Composer`, `PermissionBanner` array, and WebSocket/CLI connection status banners. Reads `pendingPermissions`, `connectionStatus`, `cliConnected` from Zustand store, calls `api.relaunchSession` on CLI disconnect.

- [Composer.tsx](./Composer.tsx) — Message input area with image attachment, slash command autocomplete (`/^\/(\S*)$/` regex), mode toggling (`Shift+Tab`), and Git status display. Sends `user_message` via `sendToSession`, optimistic UI update via `appendMessage`. Polls `filteredCommands` from `sessionData?.slash_commands` and `skills`, uses `ModeOption[]` from `CLAUDE_MODES` or `CODEX_MODES`. Opens menu when `text` matches `/^\S*$/` and `allCommands.length > 0`.

- [MessageFeed.tsx](./MessageFeed.tsx) — Chronological feed with `groupMessages` algorithm nesting subagent conversations under parent Task tool_use blocks. Virtualizes with `FEED_PAGE_SIZE` (100), auto-scrolls when `isNearBottom`, renders streaming indicator with elapsed time and token count. Delegates to `ToolMessageGroup`, `SubagentContainer`, `MessageBubble`.

- [MessageBubble.tsx](./MessageBubble.tsx) — Routes `ChatMessage` to system divider, user bubble, or `AssistantMessage` with `groupContentBlocks` merging consecutive `tool_use` blocks. Renders `MarkdownContent` with `remarkGfm`, `ThinkingBlock` with char count, `ToolBlock`, and `tool_result` with error styling.

- [PermissionBanner.tsx](./PermissionBanner.tsx) — Renders `PermissionRequest` with tool-specific displays (`BashDisplay`, `EditDisplay`, `WriteToolDetail`, `ReadDisplay`, `GlobDisplay`, `GrepDisplay`, `ExitPlanModeDisplay`, `GenericDisplay`). Handles `AskUserQuestion` multi-option forms with `selections`, `customText`, `showCustom` state. Sends `permission_response` via `sendToSession`, calls `removePermission` on dismiss.

- [ToolBlock.tsx](./ToolBlock.tsx) — Collapsible tool call cards with `getToolIcon`, `getToolLabel`, `getPreview`. Specialized detail views: `EditToolDetail` (red/green diff blocks), `WriteToolDetail` (truncated at 500 chars). Recognizes Codex `web_search` and `mcp_tool_call` types, parses `mcp:server:tool` pattern.

### Navigation and Layout

- [TopBar.tsx](./TopBar.tsx) — Header with sidebar/task-panel toggles, connection status dot, "Reconnect" button calling `api.relaunchSession`, Chat/Editor tab switcher, "Compacting..." status when `sessionStatus === "compacting"`, "Thinking" with `animate-[pulse-dot]` when `sessionStatus === "running"`.

- [Sidebar.tsx](./Sidebar.tsx) — Session list organized via `groupSessionsByProject`, renders `ProjectGroup` components with archive/restore, rename on double-click, environment manager modal, dark mode toggle, notification sound toggle. Merges `sessions` Map with `sdkSessions` array, polls `api.listSessions()` every 5000ms, hydrates server-provided names replacing auto-generated `/^[A-Z][a-z]+ [A-Z][a-z]+$/` pattern. Shows worktree confirmation modal when archiving sessions with `isWorktree` flag.

- [ProjectGroup.tsx](./ProjectGroup.tsx) — Collapsible project group header with status badges showing `runningCount` (green `text-cc-success`) and `permCount` (orange `text-cc-warning`), chevron rotation on expand/collapse. Iterates `group.sessions.map()` to render `SessionItem` components with forwarded edit/action callbacks.

- [SessionItem.tsx](./SessionItem.tsx) — Session row with status dot (color via `statusDotClass` logic: warning for permissions, success for running, muted for exited/archived), backend pill (blue for Codex, teal for Claude), Git branch with worktree indicator, Git stats (ahead/behind with ↑↓, lines added/removed with +/-), permission badge, archive/restore/delete buttons. Supports inline rename via double-click, Enter/Escape handling.

- [TaskPanel.tsx](./TaskPanel.tsx) — Right sidebar with `UsageLimitsSection` polling `api.getSessionUsageLimits` every 60000ms, renders `five_hour`, `seven_day`, `extra_usage` progress bars color-coded via `barColor(pct)`. Displays `TaskRow` list with spinner icon for `in_progress`, checkmark for `completed`, circle for `pending`, shows `blockedBy` dependencies. Hidden when `isCodex === true`.

### Session Creation and Configuration

- [HomePage.tsx](./HomePage.tsx) — Initial launcher with model/mode/backend selectors, folder picker, Git branch dropdown, worktree toggle, environment dropdown, image attachment. Calls `api.createSession` with `{ model, permissionMode: mode, cwd, envSlug, branch, createBranch, useWorktree, backend, codexInternetAccess }`, generates name via `generateUniqueSessionName`, waits for connection via `waitForConnection`, sends initial message via `sendToSession`.

- [FolderPicker.tsx](./FolderPicker.tsx) — Modal directory browser calling `api.listDirs(path)` to load `DirEntry[]`, displays recent directories from `getRecentDirs()` localStorage, supports manual path entry via `showDirInput` toggle, up-arrow navigation to parent, persists selection via `addRecentDir`.

- [EnvManager.tsx](./EnvManager.tsx) — CRUD modal for `CompanionEnv` profiles via `api.listEnvs`, `api.createEnv`, `api.updateEnv`, `api.deleteEnv`. Renders `VarEditor` with key-value rows, "+ Add variable" button, ensures minimum one empty row.

### Development and Testing

- [Playground.tsx](./Playground.tsx) — Component catalog with mock data: `PERM_BASH`, `PERM_EDIT`, `PERM_WRITE`, `PERM_READ`, `PERM_GLOB`, `PERM_GREP`, `PERM_EXIT_PLAN`, `PERM_GENERIC`, `PERM_ASK_SINGLE`, `PERM_ASK_MULTI`, `MSG_USER`, `MSG_USER_IMAGE`, `MSG_ASSISTANT`, `MSG_ASSISTANT_TOOLS`, `MSG_ASSISTANT_THINKING`, `MSG_SYSTEM`, `MSG_TOOL_ERROR`, `MOCK_TASKS`. Renders `Section`, `Card`, `TaskRow` layout helpers, passes `MOCK_SESSION_ID` to all components.

- [EditorPanel.tsx](./EditorPanel.tsx) — File tree and CodeMirror editor with auto-save after 800ms debounce, diff view via `api.getFileDiff`, changed files tracking with orange indicator. Calls `api.getFileTree(cwd)` for `TreeNode[]`, `api.readFile`, `api.writeFile`. Uses `warmTheme` with `--color-cc-*` CSS variables, `getLanguageExtension` mapping `.js/.jsx/.mjs/.ts/.tsx/.mts/.py/.html/.css/.md` to CodeMirror modes.

## Architecture Patterns

**Zustand Store Integration**: All session-scoped state keyed by `sessionId` in centralized `useStore` (from `../store.js`). Components read via selectors: `sessions.get(sessionId)`, `messages.get(sessionId)`, `pendingPermissions.get(sessionId)`, `streamingText.get(sessionId)`, `sessionTasks.get(sessionId)`, `cliConnected.get(sessionId)`, `sessionStatus.get(sessionId)`. Global state: `currentSessionId`, `darkMode`, `sidebarOpen`, `taskPanelOpen`, `activeTab`.

**WebSocket Communication**: Components call `sendToSession(sessionId, message)` from `../ws.js` to send NDJSON to CLI subprocess. Message types: `user_message`, `control_response`, `permission_response`, `set_permission_mode`. WebSocket client in `ws.ts` parses incoming messages and dispatches to store actions (`appendMessage`, `addPermission`, `updateSessionTasks`, `setStreamingText`, `setCliConnected`).

**REST API Integration**: Components import `api` from `../api.js` and call async functions: `api.createSession`, `api.listSessions`, `api.renameSession`, `api.deleteSession`, `api.archiveSession`, `api.unarchiveSession`, `api.relaunchSession`, `api.getRepoInfo`, `api.listBranches`, `api.gitFetch`, `api.gitPull`, `api.listEnvs`, `api.createEnv`, `api.updateEnv`, `api.deleteEnv`, `api.getFileTree`, `api.readFile`, `api.writeFile`, `api.getFileDiff`, `api.getBackendModels`, `api.getBackends`, `api.getSessionUsageLimits`.

**Type Imports**: TypeScript types imported from `../types.js` (client-side): `ChatMessage`, `ContentBlock`, `TaskItem`, `SessionState`, `SdkSessionInfo`, `PermissionRequest`, `BackendType`. Server types from `../../server/session-types.js`: `PermissionRequest`, `PermissionUpdate`, `SessionState`.

**Utility Functions**: Components call helpers from `../utils/`: `getRecentDirs()`, `addRecentDir()` from `recent-dirs.js`; `generateUniqueSessionName()` from `names.js`; `getModelsForBackend`, `getModesForBackend`, `getDefaultModel`, `getDefaultMode`, `toModelOptions`, `CLAUDE_MODES`, `CODEX_MODES` from `backends.js`; `groupSessionsByProject` from `project-grouping.js`.

## Behavioral Contracts

### Message Grouping

- `groupMessages(messages)` three-phase algorithm: (1) extracts `taskInfo` from all Task tool_use blocks, (2) partitions into `topLevel` vs `childrenByParent` keyed by `parentToolUseId`, (3) recursively nests via `buildEntries` into `SubagentGroup` entries
- `groupToolMessages(messages)` collapses consecutive assistant messages where all contentBlocks are `tool_use` of same `name` into `ToolMsgGroup` entries
- `getToolOnlyName(msg)` returns tool name if all contentBlocks are `tool_use` of same name and no text/thinking blocks exist

### Slash Command Autocomplete

- Opens when `text` matches `/^\S*$/` and `allCommands.length > 0`
- Filters via `/^\/(\S*)$/` regex extracting prefix after `/`
- `ArrowDown`/`ArrowUp` cycle through `filteredCommands`
- `Tab` or `Enter` call `selectCommand(filteredCommands[slashMenuIndex])`
- `selectCommand(cmd)` sets `text` to `/${cmd.name} ` and closes menu

### Auto-Save State Machine

- `fileContent !== savedContent && openFilePath !== null` → `isDirty = true`
- `saveStatus` cycles: `"dirty"` → `"saving"` → `"saved"` → `null`
- 800ms debounce timer (`saveTimerRef`) cleared on every keystroke
- Calls `api.writeFile(openFilePath, value)` after timer expires

### Connection Status Logic

- `connStatus === "connected" && !cliConnected` → shows "CLI disconnected" banner with "Reconnect" button
- `connStatus === "disconnected"` → shows "Reconnecting to session..." banner
- `isNearBottom` ref tracks if scroll within 120px of bottom, triggers auto-scroll on new messages

### Git Integration

- `gitRepoInfo` fetched via `api.getRepoInfo(cwd)` on `cwd` change
- `worktreeBranch` initialized to `info.currentBranch`, reset to false on new cwd
- Branch filter: filters `branches` by lowercase substring match, separates `localBranches` vs `remoteBranches`
- "Create new branch" button shown if filter non-empty and no exact match: `!branches.some((b) => b.name.toLowerCase() === filter)`
- Archive confirmation for worktrees: sets `confirmArchiveId`, renders "Archiving will **delete the worktree** and any uncommitted changes." banner, calls `doArchive(sessionId, true)` with `force: true`

### Session Status Display

`statusDotClass` logic chain:
- `archived` → `bg-cc-muted/40`
- `permCount > 0` → `bg-cc-warning`
- `s.sdkState === "exited"` → `bg-cc-muted/40`
- `isRunning` → `bg-cc-success`
- `isCompacting` → `bg-cc-warning`
- default → `bg-cc-success/60`

Pulse animation (`animate-[pulse-dot_1.5s_ease-in-out_infinite]`) shown when `!archived && (permCount > 0 || (isRunning && s.isConnected))`, color determined by permission state (`bg-cc-warning/40` for permissions, `bg-cc-success/40` for running).

### Project Grouping

`groupSessionsByProject` imported from `../utils/project-grouping.js` returns `ProjectGroup[]` with `key`, `label`, `sessions`, `runningCount`, `permCount`. `Sidebar` renders `ProjectGroup` component for each group, passing `isCollapsed={collapsedProjects.has(group.key)}` and `onToggleCollapse={toggleProjectCollapse}`. `ProjectGroup` shows status badges when `summaryParts.length > 0`.

### Usage Limits Display

- `POLL_INTERVAL = 60_000` — fetch via `api.getSessionUsageLimits` every 60 seconds
- Countdown refresh interval: 30,000ms
- `formatResetTime(resetsAt)` returns `"now"`, `"Nd Hh Mm"`, `"Hh Mm"`, or `"Mm"` based on millisecond diff
- `barColor(pct)` returns `"bg-cc-error"` if >80%, `"bg-cc-warning"` if >50%, else `"bg-cc-primary"`
- Extra usage shown only when `!has5h && !has7d && limits.extra_usage?.is_enabled`

### Permission Suggestion Labels

- `type: "setMode"` → `Set mode to "{mode}"`
- `type: "addRules" | "replaceRules"` → `Allow "{ruleContent}" {scope}` or `Allow {toolName} {scope}` where scope is "for session" when `destination === "session"` else "always"
- `type: "addDirectories"` → `Trust {directories[0]} {scope}`

### Tool Icon/Label Mappings

- `Bash → "terminal"`, `Read → "file"`, `Write → "file-plus"`, `Edit → "file-edit"`, `Glob → "search"`, `Grep → "search"`, `WebFetch → "globe"`, `WebSearch → "globe"`, `NotebookEdit → "file-edit"`, `TaskCreate → "list"`, `TaskUpdate → "list"`, `SendMessage → "message"`, `web_search → "globe"`, `mcp_tool_call → "tool"`
- `Bash → "Terminal"`, `Read → "Read File"`, `Write → "Write File"`, `Edit → "Edit File"`, `Glob → "Find Files"`, `Grep → "Search Content"`, `web_search → "Web Search"`, `mcp_tool_call → "MCP Tool"`
- MCP tool pattern: `mcp:server:tool` → strips `mcp:` prefix, joins remaining segments with `:`

### Language Extension Mapping

- `.js/.jsx/.mjs` → `javascript({ jsx: true })`
- `.ts/.tsx/.mts` → `javascript({ jsx: true, typescript: true })`
- `.json` → `json()`
- `.py` → `python()`
- `.html/.htm/.svelte/.vue` → `html()`
- `.css/.scss` → `css()`
- `.md/.mdx` → `markdown()`

## File Relationships

**State Flows**: `ws.ts` parses NDJSON from CLI WebSocket → dispatches to `store.ts` actions → components read via `useStore` → components send messages back via `sendToSession` in `ws.ts` → server relays to CLI process.

**Component Hierarchy**: `App.tsx` renders `TopBar`, `Sidebar`, session-specific `ChatView` or `EditorPanel`, and `TaskPanel`. `ChatView` composes `MessageFeed`, `Composer`, `PermissionBanner[]`. `MessageFeed` recursively renders `ToolMessageGroup`, `SubagentContainer`, `MessageBubble`. `MessageBubble` renders `MarkdownContent`, `ThinkingBlock`, `ToolBlock`. `HomePage` renders `FolderPicker`, `EnvManager` modals. `Sidebar` renders `ProjectGroup` which renders `SessionItem`.

**Backend Abstraction**: `backends.ts` provides `getModelsForBackend`, `getModesForBackend`, `getDefaultModel`, `getDefaultMode`, `toModelOptions`, `CLAUDE_MODES`, `CODEX_MODES`. Components call `switchBackend(newBackend)` → resets `dynamicModels`, calls `api.getBackendModels(backend)`, sets model/mode via defaults. `TopBar` and `Sidebar` render backend-specific logos: `/logo-codex.svg` vs `/logo.svg`.

**Session Hydration**: `Sidebar` polls `api.listSessions()` every 5000ms → merges server names into `sessionNames` Map → if current name matches `/^[A-Z][a-z]+ [A-Z][a-z]+$/` (auto-generated), replaces with server name → calls `markRecentlyRenamed` → triggers `animate-name-appear` CSS class.

**Permission Flow**: CLI sends `control_request` with `subtype: "can_use_tool"` → `ws.ts` parses → `store.ts` adds to `pendingPermissions.get(sessionId)` Map → `PermissionBanner` renders with tool-specific displays → user clicks Allow/Deny → `sendToSession` sends `control_response` with `behavior` → `removePermission` clears from Map.

**Task Extraction**: `ws.ts` watches for `tool_use` blocks with `name === "TaskCreate"` or `"TaskUpdate"` or `"TodoWrite"` → extracts `input.todos` or `input.task_updates` → updates `sessionTasks.get(sessionId)` array → `TaskPanel` renders `TaskRow` for each `TaskItem` with status-specific icons and `blockedBy` dependencies.