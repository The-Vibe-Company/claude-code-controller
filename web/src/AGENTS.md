<!-- Generated by agents-reverse-engineer -->

# web/src

React 19 frontend implementing the browser UI for The Vibe Companion, managing multi-session Claude Code interactions via WebSocket and REST API.

## Contents

### Application Bootstrap

- [main.tsx](./main.tsx) — Mounts `App` into `#root` via `createRoot`, wraps with `StrictMode`, imports global styles from `index.css`.

- [App.tsx](./App.tsx) — Root component with hash-based routing (`useHash` via `useSyncExternalStore` on `hashchange`), renders three-column layout (Sidebar, main content area switching between `ChatView`/`HomePage`/`EditorPanel` based on `activeTab` and `currentSessionId`, TaskPanel), responsive overlays for mobile with backdrop dismissal, auto-connects restored sessions on mount via `connectSession(restoredId)`, syncs dark mode with `document.documentElement.classList.toggle("dark", darkMode)`.

### State Management

- [store.ts](./store.ts) — Zustand store exporting `useStore` with session-keyed state: `sessions` (Map<string, SessionState>), `messages` (Map<string, ChatMessage[]>), `pendingPermissions` (Map<string, Map<string, PermissionRequest>>), `sessionTasks` (Map<string, TaskItem[]>), `streaming` (Map<string, string>), `streamingStartedAt` (Map<string, number>), `streamingOutputTokens` (Map<string, number>), `changedFiles` (Map<string, Set<string>>), `connectionStatus`, `cliConnected`, `sessionStatus`, `previousPermissionMode`, `editorOpenFile`, `editorUrl`, `editorLoading`, `collapsedProjects` (Set persisted to `cc-collapsed-projects`), plus global UI state (`darkMode`, `sidebarOpen`, `taskPanelOpen`, `homeResetKey`, `activeTab`, `notificationSound`, `recentlyRenamed` Set). Persists `sessionNames`, `currentSessionId`, `darkMode`, `notificationSound`, `collapsedProjects` to localStorage keys `cc-session-names`, `cc-current-session`, `cc-dark-mode`, `cc-notification-sound`, `cc-collapsed-projects`. Exports 50+ actions including `appendMessage`, `setStreaming`, `setStreamingStats`, `addPermission`, `addTask`, `updateTask`, `setSessionName`, `markRecentlyRenamed`, `clearRecentlyRenamed`, `setConnectionStatus`, `setEditorOpenFile`, `removeSession` (cascades cleanup across 18 state maps), `toggleProjectCollapse`, `setPreviousPermissionMode`.

### WebSocket Integration

- [ws.ts](./ws.ts) — Manages per-session WebSocket connections to `/ws/browser/:sessionId`, handles NDJSON message types (`session_init`, `session_update`, `assistant`, `stream_event`, `result`, `permission_request`, `permission_cancelled`, `status_change`, `auth_status`, `error`, `cli_disconnected`, `cli_connected`, `session_name_update`, `message_history`). Exports `connectSession`, `disconnectSession`, `disconnectAll`, `connectAllSessions`, `waitForConnection`, `sendToSession` for outgoing `BrowserOutgoingMessage`. Extracts tasks via `extractTasksFromBlocks` (parses `TodoWrite` full replacement with renumbered IDs, `TaskCreate` incremental add with auto-numbered IDs from `taskCounters` Map, `TaskUpdate` partial update with `status`/`owner`/`activeForm`/`blockedBy`), changed files via `extractChangedFilesFromBlocks` (Edit/Write `file_path` inputs), deduplicates via `processedToolUseIds` Map, computes `context_used_percent` from `modelUsage`, calls `playNotificationSound()` on result when document unfocused, schedules reconnect after 2000ms on WebSocket close, applies auto-name only when current name matches `/^[A-Z][a-z]+ [A-Z][a-z]+$/` pattern.

### API Client

- [api.ts](./api.ts) — REST client exporting session CRUD (`createSession(opts?: CreateSessionOpts)` with `backend`, `model`, `permissionMode`, `cwd`, `claudeBinary`, `codexBinary`, `codexInternetAccess`, `allowedTools`, `envSlug`, `branch`, `createBranch`, `useWorktree`, `listSessions`, `killSession`, `deleteSession`, `relaunchSession`, `archiveSession`, `unarchiveSession`, `renameSession`), filesystem ops (`listDirs`, `getHome`, `getFileTree`, `readFile`, `writeFile`, `getFileDiff`), Git worktree management (`getRepoInfo`, `listBranches`, `listWorktrees`, `createWorktree`, `removeWorktree`, `gitFetch`, `gitPull`), environment profiles (`listEnvs`, `getEnv`, `createEnv`, `updateEnv`, `deleteEnv`), backend config (`getBackends`, `getBackendModels`), editor integration (`startEditor`), usage limits (`getUsageLimits`, `getSessionUsageLimits`). All methods use internal helpers `post`, `get`, `put`, `patch`, `del` with JSON serialization, throws on non-ok HTTP responses with error message extraction.

### Type Definitions

- [types.ts](./types.ts) — Re-exports server types (`SessionState`, `PermissionRequest`, `ContentBlock`, `BrowserIncomingMessage`, `BrowserOutgoingMessage`, `BackendType`) from `../server/session-types.js`, defines client-only interfaces `ChatMessage` (with `role`, `contentBlocks`, `images`, `parentToolUseId`, `isStreaming`, `model`, `stopReason`), `TaskItem` (with `id`, `subject`, `description`, `activeForm`, `status`, `owner`, `blockedBy`), `SdkSessionInfo` (extends server session metadata with `archived`, `isWorktree`, `repoRoot`, `branch`, `actualBranch`, `gitBranch`, `gitAhead`, `gitBehind`, `totalLinesAdded`, `totalLinesRemoved`, `backendType`).

## Subdirectories

- [components/](./components/) — UI components including `ChatView`, `MessageFeed`, `MessageBubble`, `Composer`, `Sidebar`, `ProjectGroup`, `SessionItem`, `TopBar`, `TaskPanel`, `PermissionBanner`, `ToolBlock`, `HomePage`, `EditorPanel`, `Playground`, `FolderPicker`, `EnvManager`. Implements message grouping (`groupMessages`, `groupToolMessages`), slash command autocomplete (`/^\/(\S*)$/` regex), Git integration with worktree confirmation, permission displays for Bash/Edit/Write/Read/Glob/Grep/ExitPlanMode/AskUserQuestion, usage limits with countdown timers polling every 60000ms, auto-save with 800ms debounce, CodeMirror editor with diff view and `warmTheme`.

- [utils/](./utils/) — Helpers for backend/model configuration (`backends.ts` with `getModelsForBackend`, `getModesForBackend`, `getDefaultModel`, `getDefaultMode`, `toModelOptions`, `CLAUDE_MODES`, `CODEX_MODES`, `pickIcon` with `MODEL_ICONS` substring matching and modulo fallback), session naming (`names.ts` with `generateSessionName` from 40 adjectives × 40 nouns, `generateUniqueSessionName` with 100-iteration retry), project grouping (`project-grouping.ts` with `extractProjectKey` worktree normalization, `groupSessionsByProject` sorting by label/running status/createdAt), audio notifications (`notification-sound.ts` with Web Audio E5→G5 chime synthesis), directory history (`recent-dirs.ts` with LRU cache of 5 entries in `localStorage` key `cc-recent-dirs`).

## Architecture

### Data Flow

Browser ←→ WebSocket `/ws/browser/:id` ←→ Hono server (:3456) ←→ NDJSON WebSocket `/ws/cli/:id` ←→ Claude Code CLI subprocess or Codex JSON-RPC stdio. `ws.ts` parses incoming NDJSON from CLI, dispatches to `store.ts` actions (`appendMessage`, `addPermission`, `setTasks`, `setStreaming`, `setStreamingStats`), components read via `useStore` selectors, user actions trigger `sendToSession` calls relayed back to CLI.

### State Synchronization

All session state keyed by `sessionId` in Zustand store. WebSocket handlers in `ws.ts` update store, components subscribe via `useStore((s) => s.messages.get(sessionId))`, sidebar polls `api.listSessions()` every 5000ms, merges server `SdkSessionInfo[]` into `sdkSessions` array, hydrates server-provided names replacing auto-generated `/^[A-Z][a-z]+ [A-Z][a-z]+$/` pattern via `markRecentlyRenamed`, calls `clearRecentlyRenamed` after animation.

### Routing

Hash-based routing in `App.tsx` via `useHash` hook: `#/playground` → `Playground` component, default → main layout. Within main layout, `activeTab` state toggles between chat view (`ChatView` when `currentSessionId` truthy, `HomePage` when null with `key={homeResetKey}`) and `EditorPanel`. Responsive breakpoints: `md:` (768px) for sidebar, `lg:` (1024px) for task panel.

### Permission Flow

CLI sends `control_request` with `subtype: "can_use_tool"` → `ws.ts` parses → `store.addPermission(sessionId, perm)` → `ChatView` renders `PermissionBanner` array → user clicks Allow/Deny → `PermissionBanner` sends `control_response` via `sendToSession` → `store.removePermission` clears from Map. `permission_cancelled` message removes permission without user action.

### Task Extraction

`ws.ts` calls `extractTasksFromBlocks` for all `assistant` and `permission_request` messages, parses `TodoWrite` (full replace with renumbered IDs starting from 1), `TaskCreate` (incremental add with auto-numbered IDs from `taskCounters` Map, status defaults to `"pending"`), `TaskUpdate` (partial update by task ID with `status`, `owner`, `activeForm`, `blockedBy` mapped from `addBlockedBy`), stores in `sessionTasks.get(sessionId)`, `TaskPanel` renders `TaskRow` with status icons (spinner for `in_progress`, checkmark for `completed`, circle for `pending`) and `blockedBy` dependencies. Deduplication via `processedToolUseIds.get(sessionId)` Set.

### Session Lifecycle

On mount, `App.tsx` reads `useStore.getState().currentSessionId`, calls `connectSession(restoredId)` if truthy → `ws.ts` opens WebSocket to `/ws/browser/:id` via `getWsUrl` (`wss:` or `ws:` based on `location.protocol`) → server relays `session_init` with full `SessionState` → `store.addSession`, `setCliConnected(true)`, `setSessionStatus("idle")`, auto-generates name via `generateUniqueSessionName` if none exists → `ChatView` renders message history. `TopBar` shows "Reconnect" button when `cliConnected === false`, calls `api.relaunchSession` which spawns CLI with `--resume`. Sidebar organizes sessions via `groupSessionsByProject`, renders `ProjectGroup` with collapsible state from `collapsedProjects` Set.

## Behavioral Contracts

### WebSocket Message Handling

- `session_init` → `addSession`, `setCliConnected(true)`, `setSessionStatus("idle")`, generate name if absent via `generateUniqueSessionName`
- `session_update` → `updateSession`
- `assistant` → `appendMessage`, `extractTextFromBlocks`, `extractTasksFromBlocks`, `extractChangedFilesFromBlocks`, initialize `streamingStartedAt` if not set
- `stream_event` → handle `message_start` (set `streamingStartedAt`), `content_block_delta` with `text_delta` (accumulate in `streaming` Map), `message_delta` (extract `usage.output_tokens` to `streamingOutputTokens`)
- `result` → update cost/turns/context_used_percent/lines_added/lines_removed, `playNotificationSound()` if `!document.hasFocus() && notificationSound`, append system message on `is_error`
- `permission_request` → `addPermission`, construct synthetic `tool_use` block for task/file extraction
- `permission_cancelled` → `removePermission`
- `status_change` → `setSessionStatus`, special case for `"compacting"`
- `auth_status` → append system message if error
- `error` → append system message with error text
- `cli_disconnected` → `setCliConnected(false)`, `setSessionStatus(null)`
- `cli_connected` → `setCliConnected(true)`
- `session_name_update` → apply auto-name only if current name matches `/^[A-Z][a-z]+ [A-Z][a-z]+$/`, call `markRecentlyRenamed`
- `message_history` → replace messages if history length >= existing or existing is empty, extract tasks/files from all assistant messages

### Task Extraction Logic

- **TodoWrite**: expects `input.todos: Array<{content, status, activeForm}>`, calls `setTasks` with renumbered IDs starting from 1
- **TaskCreate**: increments `taskCounters[sessionId]`, builds `TaskItem` with `id=String(count)`, `subject=input.subject`, `description=input.description`, `activeForm=input.activeForm`, `status="pending"`, calls `addTask`
- **TaskUpdate**: extracts `taskId`, builds partial update with `status`, `owner`, `activeForm`, `blockedBy` (from `addBlockedBy`), calls `updateTask`
- Deduplication via `processedToolUseIds.get(sessionId)` Set, skips if `toolUseId` already processed

### Changed Files Extraction

Filters `contentBlocks` for `tool_use` with `name === "Edit" || name === "Write"`, calls `addChangedFile(sessionId, input.file_path)` if `file_path` is string.

### Context Window Calculation

In `"result"` handler, iterates `r.modelUsage` values, computes `context_used_percent = Math.round(((inputTokens + outputTokens) / contextWindow) * 100)` clamped to 0-100.

### LocalStorage Keys

- `cc-session-names` — JSON array of `[sessionId, name]` tuples
- `cc-current-session` — active session ID string
- `cc-dark-mode` — "true"/"false"
- `cc-notification-sound` — "true"/"false"
- `cc-collapsed-projects` — JSON array of collapsed project key strings
- `cc-recent-dirs` — JSON array of up to 5 directory paths

### Reconnection Strategy

- WebSocket close → `scheduleReconnect(sessionId)` after 2000ms
- Check if session archived in `sdkSessions` → skip if archived
- Call `connectSession(sessionId)` → clear existing reconnect timer on `onopen`

### Message ID Generation

`nextId()` returns `msg-${Date.now()}-${++idCounter}` with module-level `idCounter` starting at 0.

## File Relationships

`main.tsx` → `App.tsx` → `ChatView`/`EditorPanel`/`HomePage`/`Sidebar`/`TaskPanel` (all from `components/`). `ws.ts` reads from `store.ts` via `useStore.getState()`, writes via actions (`appendMessage`, `addTask`, `setTasks`, `updateTask`, `setStreaming`, `setStreamingStats`, `addPermission`, `removePermission`, `setCliConnected`, `setSessionStatus`, `markRecentlyRenamed`). `api.ts` consumed by all components for session/filesystem/git/env operations. `types.ts` re-exports server types from `../server/session-types.js`, imported by `ws.ts`, `api.ts`, all components. `utils/` helpers imported by `components/`: `generateUniqueSessionName` by `Sidebar`/`HomePage`, `getModelsForBackend`/`getModesForBackend`/`getDefaultModel`/`getDefaultMode` by `TopBar`/`HomePage`, `playNotificationSound` by `ws.ts`, `getRecentDirs`/`addRecentDir` by `FolderPicker`, `groupSessionsByProject` by `Sidebar`.