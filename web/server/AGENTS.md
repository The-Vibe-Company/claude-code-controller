<!-- Generated by agents-reverse-engineer -->

# web/server

**Bun-powered HTTP/WebSocket bridge server mediating between browser clients and Claude Code/Codex CLI backends, managing session lifecycle, git worktree isolation, environment profiles, and persistent state.**

## Contents

### Core Bridge

- **[ws-bridge.ts](./ws-bridge.ts)** — Central message router orchestrating WebSocket communication between browser clients, Claude Code CLI (NDJSON), and Codex adapters (JSON-RPC stdio). Maintains per-session `Session` objects with `messageHistory`, `pendingPermissions`, `state` snapshots, `cliSocket`, `codexAdapter`, `browserSockets` set. Handles stream events, permission requests, tool progress, auto-naming triggers, and backend reconnection. Executes git commands to populate `SessionState.git_branch`, `git_ahead`, `git_behind`, `is_worktree`, `repo_root` via `resolveGitInfo()`. Persists session data to SessionStore with debounced writes.

- **[index.ts](./index.ts)** — Server bootstrap entrypoint on port 3456. Wires together WsBridge, CliLauncher, SessionStore, WorktreeTracker. Sets `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS="1"` before imports. Serves production frontend from `dist/`. Upgrades HTTP requests matching `/ws/cli/:id` and `/ws/browser/:id` to WebSocket connections with discriminated `SocketData`. Implements 10s reconnection grace period for restored sessions via `getStartingSessions()` watchdog. Registers auto-naming callback invoking `generateSessionTitle()` after first completed turn, calls `sessionNames.setName()` and `wsBridge.broadcastNameUpdate()`.

- **[routes.ts](./routes.ts)** — Hono REST API for session CRUD (`POST /sessions/create`, `GET /sessions`, `PATCH /sessions/:id/name`, `POST /sessions/:id/kill`, `DELETE /sessions/:id`, `POST /sessions/:id/archive`, `POST /sessions/:id/unarchive`), filesystem browsing (`GET /fs/list`, `GET /fs/tree`, `GET /fs/read`, `PUT /fs/write`, `GET /fs/diff`), git operations (`GET /git/repo-info`, `GET /git/branches`, `GET /git/worktrees`, `POST /git/worktree`, `DELETE /git/worktree`, `POST /git/fetch`, `POST /git/pull`), environment profiles (`GET /envs`, `POST /envs`, `PUT /envs/:slug`, `DELETE /envs/:slug`), backend discovery (`GET /backends`, `GET /backends/:id/models`), and usage limits (`GET /usage-limits`, `GET /sessions/:id/usage-limits`). Integrates worktree cleanup with shared-worktree safety checks via `isWorktreeInUse()`. Session creation resolves `envSlug` via `envManager.getEnv()`, merges variables into `env`, conditionally creates worktree via `gitUtils.ensureWorktree()` and registers mapping via `worktreeTracker.addMapping()`, sets `codexSandbox` to `"danger-full-access"` when `codexInternetAccess === true`.

### Backend Adapters

- **[cli-launcher.ts](./cli-launcher.ts)** — Lifecycle manager for Claude Code (`--sdk-url` WebSocket) and Codex (`app-server` stdio) subprocesses. Spawns sessions via `launch()` delegating to `spawnCLI()` or `spawnCodex()` based on `backendType`, relaunches with `--resume <cliSessionId>` for Claude or fresh Codex adapter initialization, kills processes with SIGTERM (5s grace)/SIGKILL cascade. Persists `SdkSessionInfo` to disk via SessionStore. Injects git worktree guardrails as markdown section (`<!-- WORKTREE_GUARDRAILS_START -->`, `<!-- WORKTREE_GUARDRAILS_END -->`) in `.claude/CLAUDE.md` via `injectWorktreeGuardrails()` only when `worktreePath !== repoRoot` and directory exists. `restoreFromDisk()` validates PIDs with `process.kill(pid, 0)`, marks live sessions as "starting". `markConnected()` transitions sessions from "starting" to "connected". `setCLISessionId()` stores CLI internal session ID for `--resume`. Exposes `onCodexAdapterCreated()` callback for WsBridge attachment.

- **[codex-adapter.ts](./codex-adapter.ts)** — Protocol translator bridging Codex `app-server` JSON-RPC (stdin/stdout) to Vibe Companion's `BrowserIncomingMessage`/`BrowserOutgoingMessage` types. Implements `JsonRpcTransport` for NDJSON request/response matching with writer lock acquisition to prevent "WritableStream is locked" race. Handles `item/started` (routes by item type: agentMessage, commandExecution, fileChange, mcpToolCall, webSearch, reasoning, contextCompaction), `item/agentMessage/delta`, `item/completed`, `turn/completed` notifications to emit stream events, tool use/result messages, and `CLIResultMessage` with `subtype: "success" | "error_during_execution"`. Maps approval flows: `item/commandExecution/requestApproval` → Bash permission, `item/fileChange/requestApproval` → Edit permission, `item/mcpToolCall/requestApproval` → `mcp:{server}:{tool}` permission, `item/tool/requestUserInput` → AskUserQuestion format with `pendingUserInputQuestionIds` mapping. Caches rate limits via `account/rateLimits/updated`, exposes `getRateLimits()` returning `{ primary, secondary }` with `usedPercent`, `windowDurationMins`, `resetsAt`. Initializes with `initialize()` sending `clientInfo`, `capabilities`, then `thread/resume` or `thread/start`, flushes `pendingOutgoing[]` after initialization. Tracks `streamingText`, `streamingItemId`, `emittedToolUseIds`, `reasoningTextByItemId`, `pendingApprovals`, `pendingReviewDecisions`, `currentTurnId`.

### Session Management

- **[session-types.ts](./session-types.ts)** — All TypeScript interfaces for WebSocket protocol: `CLIMessage` union (CLISystemInitMessage, CLISystemStatusMessage, CLIAssistantMessage, CLIResultMessage, CLIStreamEventMessage, CLIToolProgressMessage, CLIToolUseSummaryMessage, CLIControlRequestMessage, CLIKeepAliveMessage, CLIAuthStatusMessage), `BrowserIncomingMessage` union (session_init, session_update, assistant, result, permission_request, permission_cancelled, stream_event, tool_progress, tool_use_summary, status_change, auth_status, error, cli_disconnected, cli_connected, user_message, message_history, session_name_update), `BrowserOutgoingMessage` union (user_message, permission_response, interrupt, set_model, set_permission_mode), `SessionState` (session_id, backend_type, model, cwd, tools, permissionMode, claude_code_version, mcp_servers, agents, slash_commands, skills, total_cost_usd, num_turns, context_used_percent, is_compacting, git_branch, is_worktree, repo_root, git_ahead, git_behind, total_lines_added, total_lines_removed), `PermissionRequest`, `PermissionUpdate` union (addRules, replaceRules, removeRules, setMode, addDirectories, removeDirectories), `PermissionDestination` union, `ContentBlock` union (text, tool_use, tool_result, thinking), `BackendType` union ("claude" | "codex").

- **[session-store.ts](./session-store.ts)** — File-based persistence to `$TMPDIR/vibe-sessions/`. Exports `SessionStore` class with `save()` (debounced 150ms for stream events), `saveSync()` (immediate for critical state), `load()`, `loadAll()`, `setArchived()`, `remove()`, `saveLauncher()`, `loadLauncher()`. Persists `PersistedSession` with `id`, `state`, `messageHistory`, `pendingMessages`, `pendingPermissions: [string, PermissionRequest][]` as JSON files named `${sessionId}.json`. Launcher state stored separately as `launcher.json` excluded from `loadAll()` enumeration. `debounceTimers: Map<string, ReturnType<typeof setTimeout>>` tracks pending writes per session ID.

- **[session-names.ts](./session-names.ts)** — Lazy-loaded persistent mapping from session IDs to human-readable names, stored at `~/.companion/session-names.json`. Exports `getName()`, `setName()`, `getAllNames()`, `removeName()`, `_resetForTest()`. Immediate persistence on mutation via `persist()` with JSON pretty-printing (`JSON.stringify(names, null, 2)`). `ensureLoaded()` checks `loaded` boolean, reads from `filePath` only once. `persist()` creates parent directory recursively via `mkdirSync(dirname(filePath), { recursive: true })`.

- **[auto-namer.ts](./auto-namer.ts)** — Spawns one-shot CLI processes to generate 3-5 word session titles from first user message. Exports `generateSessionTitle(firstUserMessage, model, options?)` which delegates to `generateTitleViaClaude()` (spawns `claude -p PROMPT --model MODEL --output-format json` with `Bun.spawn`, races process exit against timeout, parses JSON to extract `parsed.result`) or `generateTitleViaCodex()` (spawns `codex exec -q PROMPT --model MODEL --json`, parses JSONL events in reverse order for last `item.type === "agent_message"` with `item.completed`, extracts `item.text`). Binary resolution via `resolveClaudeBinary()`, `resolveCodexBinary()` with module-level memoization. Prompt template: `"Generate a concise 3-5 word session title for this user request. Output ONLY the title, nothing else.\n\nRequest: ${first500chars}"`. 15s timeout, quote stripping via `/^["']|["']$/g`, 100-char length validation.

### Git and Worktree Management

- **[git-utils.ts](./git-utils.ts)** — Git repository introspection and worktree management. Exports `getRepoInfo()` (repoRoot, repoName, currentBranch, defaultBranch, isWorktree), `listBranches()` (enriches with worktree mappings via `listWorktrees()`, computes ahead/behind via `getBranchStatus()`, excludes `origin/HEAD` and remote branches with local counterparts), `listWorktrees()` (parses `git worktree list --porcelain` line-by-line, marks first entry as `isMainWorktree`, calls `isWorktreeDirty()`), `ensureWorktree()` (reuses or creates worktrees with unique `-wt-{random4digit}` branch suffixes via `generateUniqueWorktreeBranch()` for concurrent sessions on same branch, handles local/remote branch detection, returns `WorktreeCreateResult` with `worktreePath`, `branch`, `actualBranch`, `isNew`), `removeWorktree()` (runs `git worktree prune` if path missing, checks `isWorktreeDirty()` unless force, removes with optional `--force` flag, deletes `branchToDelete` via `git branch -D`), `gitFetch()`, `gitPull()`, `checkoutBranch()`, `getBranchStatus()` (parses `git rev-list --left-right --count origin/{branch}...{branch}` as `{behind} {ahead}`). Worktree paths resolve to `~/.companion/worktrees/{repoName}/{sanitizedBranch}` via `worktreeDir()` helper. Branch sanitization via `sanitizeBranch()` replacing `/` with `--`. All git commands use 10s timeout.

- **[worktree-tracker.ts](./worktree-tracker.ts)** — Persistent registry mapping session IDs to git worktree paths, stored as JSON at `~/.companion/worktrees.json`. Exports `WorktreeTracker` class with `load()`, `addMapping()`, `removeBySession()`, `getBySession()`, `getSessionsForWorktree()`, `getSessionsForRepo()`, `isWorktreeInUse(worktreePath, excludeSessionId?)`. `WorktreeMapping` interface captures `sessionId`, `repoRoot`, `branch` (conceptual user-selected branch), `actualBranch` (actual git branch name for `-wt-N` suffixed branches), `worktreePath`, `createdAt`. Private `save()` method writes with pretty-printing via `mkdirSync(dirname(TRACKER_PATH), { recursive: true })` and `writeFileSync`.

### Environment and Usage

- **[env-manager.ts](./env-manager.ts)** — CRUD for named environment variable profiles stored at `~/.companion/envs/{slug}.json`. Exports `listEnvs()` (reads all `.json` files, sorts by name with `localeCompare`), `getEnv(slug)`, `createEnv(name, variables)`, `updateEnv(slug, updates)` (handles slug changes by deleting old file, preserves `createdAt`), `deleteEnv(slug)`. `CompanionEnv` interface: `name`, `slug` (via `slugify()`: lowercase, `.replace(/\s+/g, "-")`, `.replace(/[^a-z0-9-]/g, "")`, `.replace(/-+/g, "-")`, `.replace(/^-|-$/g, "")`), `variables: Record<string, string>`, `createdAt`, `updatedAt`. Throws errors for empty names, empty slugs, existing slugs. `ensureDir()` called before every operation via `mkdirSync(ENVS_DIR, { recursive: true })`.

- **[usage-limits.ts](./usage-limits.ts)** — Fetches and caches Claude Code OAuth usage limits from `https://api.anthropic.com/api/oauth/usage` with 60s in-memory cache (`CACHE_DURATION_MS = 60000`). Exports `getUsageLimits()` (main entry point checking cache, refreshing tokens via `getValidAccessToken()`, calling `fetchUsageLimits()`, returning `UsageLimits` or empty object with nulls), `getCredentials()`, `fetchUsageLimits(token)` (sends `User-Agent: claude-code/2.1.39`, `anthropic-beta: oauth-2025-04-20` headers). Refreshes expired tokens via `refreshAccessToken(refreshToken)` posting to `OAUTH_TOKEN_URL = "https://platform.claude.com/v1/oauth/token"` with `grant_type=refresh_token`, `client_id=${OAUTH_CLIENT_ID}` (`9d1c250a-e61b-44d9-88ed-5944d1962f5e`). Reads/writes credentials from macOS Keychain (`security find-generic-password -s "Claude Code-credentials" -w`, decodes hex if needed, updates via `security add-generic-password -U`) or Windows (`~/.claude/.credentials.json`). Returns `UsageLimits` with `five_hour`, `seven_day`, `extra_usage` (each nullable with `utilization`, `resets_at` for time windows; `is_enabled`, `monthly_limit`, `used_credits`, `utilization` for extra_usage). 5s timeout on all execSync calls.

## Architecture

### Data Flow

Browser clients connect via `/ws/browser/:id`, CLI processes connect via `/ws/cli/:id`, Codex adapters communicate over stdio. WsBridge maintains session registry, routing NDJSON from CLI to JSON for browsers, and vice versa. CliLauncher spawns/kills processes, stores PIDs and state in SessionStore. Auto-naming callback in index.ts invokes auto-namer after first completed turn. Git worktree guardrails injected by CliLauncher on session creation when `worktreeInfo` present.

### Session Lifecycle

1. `POST /sessions/create` → `launcher.launch()` → spawns CLI via `spawnCLI()` or Codex adapter via `spawnCodex()`
2. CLI WebSocket handshake → `wsBridge.handleCLIOpen()` → `launcher.markConnected()` → transitions to "connected" state
3. Codex adapter created → `launcher.onCodexAdapter` callback → `wsBridge.attachCodexAdapter()` → registers `onBrowserMessage`, `onSessionMeta`, `onDisconnect` callbacks
4. Browser reconnection → `wsBridge.handleBrowserOpen()` → replays `messageHistory`, sends pending permissions, invokes `onCLIRelaunchNeeded` if backend dead
5. Server restart → `launcher.restoreFromDisk()` + `wsBridge.restoreFromDisk()` → 10s grace period via `getStartingSessions()` watchdog → relaunch stale sessions
6. `DELETE /sessions/:id` → kill process, cleanup worktree if exclusive via `cleanupWorktree()`, remove from store

### Worktree Isolation

Routes use WorktreeTracker to map sessions to worktrees. `ensureWorktree()` generates unique branch names (`{branch}-wt-{random4digit}`) via `generateUniqueWorktreeBranch()` when reusing worktree for same conceptual branch. Cleanup checks `isWorktreeInUse()` before removing worktree and optionally deletes companion-managed branches via `branchToDelete` parameter. Guardrails markdown forbids `git checkout/switch`, suggests `git show other-branch:path` for cross-branch references.

## Behavioral Contracts

### NDJSON Protocol

CLI messages delimited by `\n`. WsBridge splits on newlines, filters empty lines, parses each line independently. CLI-bound messages from `sendToCLI()` append `\n` delimiter. Codex adapter uses identical newline-delimited JSON-RPC over stdin/stdout via `JsonRpcTransport.send()` (appends `\n`), `.onData()` (splits on `\n`), `processBuffer()` (parses complete lines).

### Git Commands

- `git rev-parse --abbrev-ref HEAD` — current branch
- `git rev-parse --git-dir` — worktree detection (checks for `/worktrees/` substring)
- `git rev-parse --git-common-dir` — shared `.git` dir (worktree only, used by `resolveGitInfo`)
- `git rev-parse --show-toplevel` — repo root (non-worktree)
- `git rev-list --left-right --count origin/{branch}...{branch}` → `{behind} {ahead}` (parsed via split on whitespace)
- `git for-each-ref refs/heads/ --format '%(refname:short)|%(worktreepath)'` — local branches
- `git for-each-ref refs/remotes/origin/ --format '%(refname:short)|%(worktreepath)'` — remote branches
- `git worktree list --porcelain` — parses lines prefixed `worktree `, `HEAD `, `branch `, `bare`
- `git worktree add -b {branch} "{path}" {base}` — create worktree
- `git worktree remove "{worktreePath}"` — remove worktree (optionally with `--force`)
- `git worktree prune` — cleanup stale worktree metadata
- `git branch -D {branchToDelete}` — delete branch
- `git status --porcelain` — dirty check (non-empty output = dirty)
- `git fetch --prune` — fetch with remote pruning
- `git pull` — pull changes
- `git diff HEAD -- "${absPath}"` — file diff

All execSync calls use `timeout: 10_000` ms except routes (3000–5000ms range), usage-limits (5000ms), env-manager (no timeout).

### Auto-Naming Prompt Template

```
Generate a concise 3-5 word session title for this user request. Output ONLY the title, nothing else.

Request: ${first500chars}
```

Claude backend: `claude -p PROMPT --model MODEL --output-format json`, extracts `parsed.result`.  
Codex backend: `codex exec -q PROMPT --model MODEL --json`, parses JSONL for last `item.type === "agentMessage"` with `item.completed`, extracts `item.text`.

Both strip quotes via regex `/^["']|["']$/g`, validate length < 100 characters, 15s timeout.

### Permission Flow

1. CLI sends `control_request` (subtype `can_use_tool`) → WsBridge stores in `pendingPermissions` map → broadcast `permission_request` to browsers
2. Browser sends `permission_response` → WsBridge removes from map → sends `control_response` to CLI with `behavior: "allow"` or `behavior: "deny"`
3. Codex: `item/commandExecution/requestApproval` → stores JSON-RPC id in `pendingApprovals` → `PermissionRequest` → browser response → `{ decision: "accept" | "decline" }` JSON-RPC response. `item/tool/requestUserInput` → `AskUserQuestion` format with `pendingUserInputQuestionIds` mapping request_id to ordered Codex question IDs → browser response → `ToolRequestUserInputResponse: { answers: { [questionId]: { answers: [string] } } }`

### Context Usage Calculation

`Math.round(((inputTokens + outputTokens) / contextWindow) * 100)` clamped to `[0, 100]`. Extracted from `msg.modelUsage[model].inputTokens`, `msg.modelUsage[model].outputTokens`, `msg.modelUsage[model].modelContextWindow` in result messages.

### Worktree Guardrails Injection

Markers: `<!-- WORKTREE_GUARDRAILS_START -->` and `<!-- WORKTREE_GUARDRAILS_END -->`. Only injects when `worktreePath !== repoRoot` and `existsSync(worktreePath)`. Content includes branch label (with `parentBranch` if provided), main repo path, rules forbidding `git checkout/switch`, enforcing commits to current branch only, suggesting `git show other-branch:path`. Written to `.claude/CLAUDE.md` in worktree, replacing existing section or appending.

## Import Map

- `./session-types.js` — imported by ws-bridge, routes, cli-launcher, codex-adapter
- `./session-store.js` — imported by index, cli-launcher, ws-bridge, routes
- `./codex-adapter.ts` — imported by cli-launcher, index (via onCodexAdapterCreated callback)
- `./env-manager.ts` — imported by routes
- `./git-utils.ts` — imported by routes, ws-bridge (via resolveGitInfo)
- `./session-names.ts` — imported by index, routes
- `./worktree-tracker.ts` — imported by index, routes
- `./usage-limits.ts` — imported by routes
- `./auto-namer.ts` — imported by index