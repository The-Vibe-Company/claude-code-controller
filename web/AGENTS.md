<!-- Generated by agents-reverse-engineer -->

# web

The Vibe Companion web application — a monorepo workspace containing Bun+Hono backend server, React 19 frontend, and CLI entry point. Orchestrates protocol translation between browser WebSockets and Claude Code/Codex CLI backends, manages session persistence, git worktree isolation, and environment profiles.

## Stack

**Runtime**: Bun 1.0+  
**Backend**: Hono 4.7 (WebSocket+REST on port 3456)  
**Frontend**: React 19 + Vite 6.3 (dev server on port 5174, production assets served from `dist/`)  
**State**: Zustand 5.0 (client-side session store)  
**Persistence**: JSON files (`$TMPDIR/vibe-sessions/`, `~/.companion/`, macOS Keychain)  
**Testing**: Vitest 4.0 with jsdom for React components, Node.js for server  
**CLI**: Published as `the-vibe-companion` via `bin/cli.ts`

## Contents

### Configuration

- [package.json](./package.json) — Package manifest defining name `the-vibe-companion`, version `0.18.0`, bin entry point `./bin/cli.ts`, scripts for `dev`/`build`/`start`/`test`, runtime dependencies (hono), devDependencies (React 19, Vite, Zustand, CodeMirror, xterm.js, vitest, tailwindcss), `engines.bun: ">=1.0.0"`, `files: ["bin/", "server/", "dist/"]` for npm publish.

- [tsconfig.json](./tsconfig.json) — TypeScript config targeting ES2022 with `jsx: "react-jsx"`, `moduleResolution: "bundler"`, `strict: true`, `noEmit: true`, `types: ["vitest/globals"]`, includes both `src/` and `server/` directories.

- [vite.config.ts](./vite.config.ts) — Vite bundler config with `react()` and `tailwindcss()` plugins, dev server on port 5174 bound to `"0.0.0.0"`, proxies `/api` and `/ws` to backend `http://localhost:3456`.

- [vitest.config.ts](./vitest.config.ts) — Vitest test runner with `globals: true`, default environment `"node"`, `environmentMatchGlobs` mapping `src/**/*.test.ts` and `src/**/*.test.tsx` to jsdom, `setupFiles: ["src/test-setup.ts"]`.

### Development Tooling

- [dev.ts](./dev.ts) — Parallel dev server orchestrator spawning two Bun subprocesses via `spawn()`: backend (`bun --watch server/index.ts` with cyan `[backend]` prefix) and vite (`bun run dev:vite` with magenta `[vite]` prefix). Multiplexes stdout/stderr via `prefix()` reader using `TextDecoder`, registers `SIGINT`/`SIGTERM` cleanup calling `.kill()` on all processes, races process exit for immediate shutdown with error message.

### Documentation

- [CODEX_MAPPING.md](./CODEX_MAPPING.md) — Protocol translation spec mapping Codex JSON-RPC 2.0 stdio messages (`item/started`, `item/agentMessage/delta`, `item/completed`, `turn/completed`, `item/commandExecution/requestApproval`, `item/fileChange/requestApproval`) to Vibe Companion browser WebSocket types (`stream_event`, `assistant`, `tool_use`, `tool_result`, `permission_request`, `CLIResultMessage`). Documents `mapApprovalPolicy()` conversion (bypassPermissions → `"never"`, acceptEdits/plan/default → `"untrusted"`), `initialize`/`thread/start`/`thread/resume` lifecycle, item type mappings (agentMessage, commandExecution → Bash, fileChange → Write/Edit, mcpToolCall → `mcp:{server}:{tool}`, webSearch → WebSearch, reasoning → thinking, contextCompaction → status indicator), `SessionState` synthesis (hardcoded 0 for cost/context, empty arrays for tools/mcp_servers), known limitations (token usage not extracted from `turn/completed`, no runtime model/permission switching, MCP/WebSearch approval auto-accepted).

## Subdirectories

- [bin/](./bin/) — CLI entry point `cli.ts` setting `__VIBE_PACKAGE_ROOT` and `NODE_ENV` before importing `server/index.ts`. Maps package.json `bin.the-vibe-companion` to this shebang script for `bunx` invocation.

- [server/](./server/) — Bun+Hono backend with `index.ts` bootstrap (port 3456, dual WebSocket upgrade, 10s reconnection grace period, auto-naming callback), `ws-bridge.ts` message router (maintains per-session `Session` with `messageHistory`/`pendingPermissions`/`state`/`cliSocket`/`codexAdapter`/`browserSockets`, executes `resolveGitInfo()` for git metadata), `cli-launcher.ts` subprocess manager (spawns Claude Code with `--sdk-url` or Codex `app-server`, relaunches with `--resume`, injects worktree guardrails), `codex-adapter.ts` JSON-RPC translator (`JsonRpcTransport` with writer lock, `item/started` routing, `pendingApprovals`/`pendingUserInputQuestionIds` tracking, rate limits caching), `session-store.ts` file persistence (debounced 150ms for streams, `PersistedSession` JSON), `routes.ts` REST API (session CRUD, filesystem ops, git operations with `isWorktreeInUse()` safety checks, environment profiles, backend discovery, usage limits), `git-utils.ts`/`worktree-tracker.ts` (worktree isolation at `~/.companion/worktrees/{repoName}/{sanitizedBranch}`, persistent mappings, `ensureWorktree()` with `-wt-{random4digit}` suffixes), `env-manager.ts` (CRUD for profiles at `~/.companion/envs/{slug}.json`, `slugify()` normalization), `usage-limits.ts` (OAuth token refresh, macOS Keychain/Windows JSON credentials, 60s cache), `auto-namer.ts` (spawns one-shot `claude`/`codex exec` processes with 15s timeout, 500-char prompt, quote stripping), `session-types.ts` (all protocol interfaces: `CLIMessage`, `BrowserIncomingMessage`, `BrowserOutgoingMessage`, `SessionState`, `PermissionRequest`, `ContentBlock`, `BackendType`), `session-names.ts` (lazy-loaded mapping at `~/.companion/session-names.json`, immediate persistence).

- [src/](./src/) — React 19 frontend with `App.tsx` root layout (hash routing via `useHash` + `useSyncExternalStore` on `hashchange`, three-column grid with Sidebar/ChatView/HomePage/EditorPanel/TaskPanel, responsive overlays, auto-connects restored sessions, syncs dark mode to `document.documentElement.classList`), `store.ts` Zustand session state (50+ actions including `appendMessage`, `setStreaming`, `setStreamingStats`, `addTask`, `updateTask`, `addPermission`, `removePermission`, `setSessionName`, `markRecentlyRenamed`, `clearRecentlyRenamed`, `removeSession` cascading cleanup, `toggleProjectCollapse`, `setPreviousPermissionMode`, localStorage persistence for `cc-session-names`/`cc-current-session`/`cc-dark-mode`/`cc-notification-sound`/`cc-collapsed-projects`), `ws.ts` WebSocket client with NDJSON parsing (`extractTasksFromBlocks` handling TodoWrite/TaskCreate/TaskUpdate, `extractChangedFilesFromBlocks`, `processedToolUseIds` deduplication, `taskCounters` auto-numbering, 2000ms reconnect delay, `playNotificationSound()` on result, auto-name regex `/^[A-Z][a-z]+ [A-Z][a-z]+$/`), `api.ts` REST client (session CRUD with `CreateSessionOpts` including `backend`/`model`/`permissionMode`/`cwd`/`envSlug`/`branch`/`useWorktree`, filesystem ops, git operations, environment profiles, backend config, editor integration, usage limits), `types.ts` (re-exports server types, client-only `ChatMessage`/`TaskItem`/`SdkSessionInfo`). Subdirectories: `components/` (ChatView, MessageFeed, MessageBubble, Composer, Sidebar, ProjectGroup, SessionItem, TopBar, TaskPanel, PermissionBanner, ToolBlock, HomePage, EditorPanel, Playground, FolderPicker, EnvManager with message grouping, slash command autocomplete, Git worktree confirmation, permission displays, usage limits countdown, 800ms auto-save debounce, CodeMirror with `warmTheme`), `utils/` (backends.ts with `getModelsForBackend`/`getModesForBackend`/`getDefaultModel`/`getDefaultMode`/`toModelOptions`/`pickIcon`, names.ts with `generateSessionName` from 40 adjectives × 40 nouns, project-grouping.ts with `extractProjectKey` worktree normalization, notification-sound.ts with Web Audio E5→G5 synthesis, recent-dirs.ts with LRU cache of 5 entries).

## Architecture

### Data Flow

```
Browser React App (:5174 dev, dist/ prod)
  ↓ WebSocket /ws/browser/:id
Hono Server (:3456)
  ├→ ws-bridge.ts (message router, session state)
  ├→ cli-launcher.ts → Claude Code CLI (--sdk-url ws://localhost:3456/ws/cli/:id)
  └→ codex-adapter.ts → Codex app-server (stdio JSON-RPC)
```

Frontend connects per session via `ws.ts` to `/ws/browser/:id`. Backend upgrades HTTP requests to WebSocket based on URL pattern (`/ws/cli/:id` for CLI processes, `/ws/browser/:id` for browsers) with discriminated `SocketData`. `ws-bridge.ts` maintains `Session` with `messageHistory`, `pendingPermissions`, `state`, `codexAdapter`, delegates to `CliLauncher` for process lifecycle, `SessionStore` for disk persistence.

### Backend Selection

Routes expose `GET /api/backends` returning array of `{id: "claude-code" | "codex", name, available}`. Frontend `api.getBackends()` populates backend selector in `HomePage`. Session creation sends `backend: BackendType` to `POST /api/sessions/create`, `CliLauncher.launch()` branches on backend: spawns `claude` with `--sdk-url` for Claude Code (via `spawnCLI()`), spawns `codex app-server` and creates `CodexAdapter` for Codex (via `spawnCodex()`). All WsBridge message routing is backend-agnostic after adapter creation.

### Session Persistence

`SessionStore` writes debounced JSON to `$TMPDIR/vibe-sessions/{sessionId}.json` (150ms for stream events, immediate for critical state via `saveSync()`). Persisted fields: `id`, `state` (model, cwd, tools, permissionMode, git_branch, cost, context), `messageHistory` (full `BrowserIncomingMessage[]`), `pendingMessages` (queued while CLI disconnected), `pendingPermissions` (Map→Array serialization). On server restart, `WsBridge.restoreFromDisk()` rehydrates state, `CliLauncher.restoreFromDisk()` detects stale PIDs via 10s grace period, relaunches with `--resume <cliSessionId>` for Claude Code or fresh adapter for Codex. Launcher state stored separately as `launcher.json`.

### Git Worktree Isolation

`git-utils.ts` exports `ensureWorktree(repoRoot, branch)` creating unique worktree paths at `~/.companion/worktrees/{repoName}/{sanitizedBranch}` (sanitization via `sanitizeBranch()` replacing `/` with `--`), generates `-wt-{random4digit}` branch suffixes via `generateUniqueWorktreeBranch()` for concurrent sessions on same branch. `WorktreeTracker` persists session-to-worktree mappings at `~/.companion/worktrees.json` with `WorktreeMapping` interface (sessionId, repoRoot, branch, actualBranch, worktreePath, createdAt). `CliLauncher.launch()` injects markdown guardrails into `.claude/CLAUDE.md` via `injectWorktreeGuardrails()` when `worktreePath !== repoRoot` and directory exists, with markers `<!-- WORKTREE_GUARDRAILS_START -->`/`<!-- WORKTREE_GUARDRAILS_END -->`, forbidding `git checkout/switch`, enforcing commits to current branch. Routes expose `POST /api/git/worktree`, `DELETE /api/git/worktree` with shared-worktree safety checks via `isWorktreeInUse()`. Cleanup deletes companion-managed branches via `branchToDelete` parameter.

### Environment Profiles

`EnvManager` stores named variable sets at `~/.companion/envs/{slug}.json` with interface `CompanionEnv` (name, slug, variables: Record<string,string>, createdAt, updatedAt). Slug generation via `slugify()`: lowercase, `.replace(/\s+/g, "-")`, `.replace(/[^a-z0-9-]/g, "")`, `.replace(/-+/g, "-")`, `.replace(/^-|-$/g, "")`. Routes expose CRUD endpoints: `GET /envs`, `POST /envs`, `PUT /envs/:slug` (handles slug changes by deleting old file, preserves `createdAt`), `DELETE /envs/:slug`. `HomePage` component consumes via `api.listEnvs()`, `api.createEnv()`, displays `EnvManager` modal with key-value editor. Session creation resolves `envSlug` via `envManager.getEnv()`, merges variables into `env`.

### Auto-Naming Pipeline

On session creation, `index.ts` registers callback with `WsBridge` to invoke `auto-namer.ts` after first completed turn. `generateSessionTitle()` extracts first 500 chars of user message, spawns one-shot CLI process: `claude -p PROMPT --model MODEL --output-format json` for Claude backend (via `generateTitleViaClaude()`, parses `parsed.result` from JSON), `codex exec -q PROMPT --model MODEL --json` for Codex backend (via `generateTitleViaCodex()`, parses JSONL in reverse for last `item.type === "agent_message"` with `item.completed`, extracts `item.text`). Binary resolution via `resolveClaudeBinary()`, `resolveCodexBinary()` with module-level memoization. Prompt template: `"Generate a concise 3-5 word session title for this user request. Output ONLY the title, nothing else.\n\nRequest: ${first500chars}"`. Strips quotes via `/^["']|["']$/g`, validates length < 100, persists via `SessionNames.setName()`, broadcasts update to browsers via `wsBridge.broadcastNameUpdate()`. 15s timeout, logged warnings on failure.

### Task Extraction

`ws.ts` parses all `assistant` and `permission_request` messages for `tool_use` blocks named `TodoWrite`, `TaskCreate`, `TaskUpdate` via `extractTasksFromBlocks()`. Logic:
- **TodoWrite**: expects `input.todos: Array<{content, status, activeForm}>`, calls `setTasks` with renumbered IDs starting from 1
- **TaskCreate**: increments `taskCounters[sessionId]`, builds `TaskItem` with `id=String(count)`, `subject=input.subject`, `description=input.description`, `activeForm=input.activeForm`, `status="pending"`, calls `addTask`
- **TaskUpdate**: extracts `taskId` from `input`, builds partial update with `status`, `owner`, `activeForm`, `blockedBy` (from `addBlockedBy`), calls `updateTask`

Deduplicates via `processedToolUseIds.get(sessionId)` Set. `TaskPanel` subscribes to `sessionTasks.get(sessionId)`, renders `TaskRow` with status icons (spinner for `in_progress`, checkmark for `completed`, circle for `pending`), filters by owner/status, displays `blockedBy` dependencies.

## Structure

Top-level `web/` contains config files (`package.json`, `tsconfig.json`, `vite.config.ts`, `vitest.config.ts`), dev orchestrator (`dev.ts`), documentation (`CODEX_MAPPING.md`). Three subdirectories: `bin/` (CLI shim), `server/` (Hono backend modules), `src/` (React frontend source). All TypeScript code in `server/` and `src/` covered by single `tsconfig.json` with bundler module resolution. Tests colocated with source (`routes.test.ts`, `codex-adapter.test.ts`) or in `src/__tests__/`, environment selected via vitest `environmentMatchGlobs`.

## Behavioral Contracts

### NDJSON Protocol

CLI processes write newline-delimited JSON to WebSocket. `WsBridge.handleCLIMessage()` splits `data` on `\n`, filters empty lines, parses each line via `JSON.parse()`. Codex adapter uses identical newline-delimited JSON-RPC over stdin/stdout via `JsonRpcTransport.send()` (appends `\n`), `.onData()` (splits on `\n`), `processBuffer()` (parses complete lines). Browser WebSockets receive typed JSON messages without delimiters.

### Git Command Patterns

All git operations in `git-utils.ts` use `execSync` with `timeout: 10_000` ms except routes (3000–5000ms range):
- `git rev-parse --abbrev-ref HEAD` → current branch
- `git rev-parse --show-toplevel` → repo root (non-worktree)
- `git rev-parse --git-dir` → worktree detection (checks `/worktrees/` substring)
- `git rev-parse --git-common-dir` → shared `.git` dir (worktree only, used by `resolveGitInfo`)
- `git rev-list --left-right --count origin/{branch}...{branch}` → `{behind} {ahead}` (parsed via split on whitespace)
- `git for-each-ref refs/heads/ --format '%(refname:short)|%(worktreepath)'` — local branches
- `git for-each-ref refs/remotes/origin/ --format '%(refname:short)|%(worktreepath)'` — remote branches
- `git worktree list --porcelain` → parses lines prefixed `worktree `, `HEAD `, `branch `, `bare`
- `git worktree add -b {branch} "{path}" {base}` → create worktree
- `git worktree remove "{worktreePath}"` (optionally with `--force`)
- `git worktree prune` → cleanup stale metadata
- `git branch -D {branchToDelete}` → delete branch
- `git status --porcelain` → dirty check (`isWorktreeDirty()`)
- `git fetch --prune`, `git pull`
- `git diff HEAD -- "${absPath}"` → file diff

### Auto-Naming Prompt Template

```
Generate a concise 3-5 word session title for this user request. Output ONLY the title, nothing else.

Request: ${first500chars}
```

Claude backend: `claude -p PROMPT --model MODEL --output-format json`, extracts `parsed.result`.  
Codex backend: `codex exec -q PROMPT --model MODEL --json`, parses JSONL for last `item.type === "agentMessage"` with `item.completed`, extracts `item.text`.

Both strip quotes via `/^["']|["']$/g`, validate length < 100 characters, 15s timeout.

### Permission Request Flow

Claude Code: CLI sends `control_request` (subtype `can_use_tool`) → WsBridge stores in `pendingPermissions` Map → broadcasts `permission_request` to browsers → user responds → WsBridge sends `control_response` (behavior `"allow"` or `"deny"`).

Codex: adapter receives `item/commandExecution/requestApproval` or `item/fileChange/requestApproval` JSON-RPC request → stores request ID in `pendingApprovals` → synthesizes `permission_request` → user responds → sends JSON-RPC response `{decision: "accept" | "decline"}`. `item/tool/requestUserInput` → `AskUserQuestion` format with `pendingUserInputQuestionIds` mapping request_id to ordered Codex question IDs → browser response → `ToolRequestUserInputResponse: { answers: { [questionId]: { answers: [string] } } }`.

### WebSocket Reconnection

Browser: `ws.ts` registers `onclose` handler calling `scheduleReconnect(sessionId)` after 2000ms. Checks if session archived in `sdkSessions` before reconnecting. Clears timeout on `onopen`.

CLI: On disconnect, WsBridge stores pending messages in `pendingMessages[]`, waits 10s grace period. If CLI reconnects (server restart case), replays queue. If timeout expires, `CliLauncher.relaunchSession()` kills stale PID, spawns with `--resume <cliSessionId>`.

### LocalStorage Persistence

`store.ts` subscribes to Zustand state changes, writes to localStorage:
- `cc-session-names` → JSON array of `[sessionId, name]` tuples
- `cc-current-session` → active session ID string
- `cc-dark-mode` → `"true"` or `"false"`
- `cc-notification-sound` → `"true"` or `"false"`
- `cc-collapsed-projects` → JSON array of collapsed project key strings

`utils/recent-dirs.ts` persists LRU cache to `cc-recent-dirs` (max 5 entries).

### Context Usage Calculation

Extracted from `result` messages: `Math.round(((inputTokens + outputTokens) / contextWindow) * 100)` clamped to `[0, 100]`. Reads `msg.modelUsage[model].inputTokens`, `msg.modelUsage[model].outputTokens`, `msg.modelUsage[model].modelContextWindow`.

### Worktree Guardrails Injection

Markers: `<!-- WORKTREE_GUARDRAILS_START -->` and `<!-- WORKTREE_GUARDRAILS_END -->`. Only injects when `worktreePath !== repoRoot` and `existsSync(worktreePath)`. Content includes branch label (with `parentBranch` if provided), main repo path, rules forbidding `git checkout/switch`, enforcing commits to current branch only, suggesting `git show other-branch:path`. Written to `.claude/CLAUDE.md` in worktree, replacing existing section or appending.

## File Relationships

`dev.ts` spawns `server/index.ts` and vite, orchestrates shutdown. `bin/cli.ts` imports `server/index.ts` for production execution. `server/index.ts` wires together `WsBridge`, `CliLauncher`, `SessionStore`, `WorktreeTracker`, registers routes from `routes.ts`, serves `dist/` when `NODE_ENV=production`. `server/ws-bridge.ts` delegates subprocess lifecycle to `cli-launcher.ts`, message translation to `codex-adapter.ts`, persistence to `session-store.ts`, git metadata to `git-utils.ts` (`resolveGitInfo`). `src/App.tsx` imports `ws.ts` for WebSocket management, `api.ts` for REST calls, `store.ts` for state subscriptions. All components in `src/components/` consume `store.ts` via `useStore` selectors, call `api.ts` functions, send messages via `sendToSession` from `ws.ts`. `src/types.ts` re-exports `server/session-types.ts` for shared protocol definitions across client and server. `src/utils/backends.ts` consumed by `TopBar`/`HomePage` for model/mode dropdowns, `utils/names.ts` by `Sidebar`/`HomePage` for session naming, `utils/project-grouping.ts` by `Sidebar` for session organization, `utils/notification-sound.ts` by `ws.ts` for audio notifications, `utils/recent-dirs.ts` by `FolderPicker` for directory history.